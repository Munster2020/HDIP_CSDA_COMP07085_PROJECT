<html>
<head>
    <title>dvds</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        body {
            margin: 50px;
            background-color: white;
            font-family: Verdana, Geneva, Tahoma, sans-serif
        }

        button {
            margin:5px;
        }
        h1 {
            margin: 20px;
            color: green;
            text-align: center;
        }
        h2 {
            margin: 20px;
            color: green;
        }
        .center {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 50%;
        }
    </style>
</head>
<body>
    <h1>dvds</h1>
    <div id="create-update" style="display:none">
        <h2><span id="createLabel">Create a</span> <span id="updateLabel">Update</span> dvd</h2>
        <table class = "table" id ="createUpdateForm" >
            <tr>
                <td>id</td>
                <td><input type="number" name="id" id ="id"></td>
            </tr>
            <tr>
                <td>title</td>
                <td><input type="text" name="title"></td>
            </tr>
            <tr>
                <td>director</td>
                <td><input type="text" name="director"></td>
            </tr>
            <tr>
                <td>genre</td>
                <td><input type="text" name="genre"></td>
            </tr>
            <tr>
                <td>price</td>
                <td><input type="number" name="price"></td>
            </tr>
            <tr>
                <td></td>
                <td><button id="create-button" onClick="doCreate()" type="button" class="btn btn-success">Create</button></td>
                <td><button id="update-button" onClick="doUpdate()" type="button" class="btn btn-success">Update</button></td>
            </tr>
        </table>
    </div>
    <div id="display">
        <button onClick="showCreate()" type="button" class="btn btn-success">Create</button>
        <table id = "dvdTable" class = "table">
            <tr>
                <th>ID</th>
                <th>TITLE</th>
                <th>DIRECTOR</th>
                <th>GENRE</th>
                <th colspan="2">PRICE</th>
            </tr>                                       
        </table>
    </div>
    <script>
        function showCreate(){
            document.getElementById('display').style.display = "none"
            document.getElementById('create-button').style.display = "block"
            document.getElementById('update-button').style.display = "none"
            document.getElementById('create-update').style.display = "block"
            document.getElementById('createLabel').style.display = "inline"
            document.getElementById('updateLabel').style.display = "none"
        }
        function showUpdate(thisElem){
            var rowElement = thisElem.parentNode.parentNode;
 
            dvd = readDvdFromRow(rowElement)
            populateForm(dvd)

            document.getElementById('display').style.display = "none"
            document.getElementById('create-button').style.display = "none"
            document.getElementById('update-button').style.display = "block"
            document.getElementById('create-update').style.display = "block"
            document.getElementById('createLabel').style.display = "none"
            document.getElementById('updateLabel').style.display = "inline"       
        }
        function readDvdFromRow(rowElement){
            dvd = {}
            dvd.id = rowElement.getAttribute("id");
            dvd.title = rowElement.cells[1].firstChild.textContent
            dvd.director = rowElement.cells[2].firstChild.textContent
            dvd.genre = rowElement.cells[3].firstChild.textContent
            dvd.price = rowElement.cells[4].firstChild.textContent
            return dvd
        }
        function populateForm(dvd){
            var form = document.getElementById('createUpdateForm')

            form.querySelector('input[name="id"]').value = dvd.id
            form.querySelector('input[name="id"]').disabled = true
            form.querySelector('input[name="title"]').value = dvd.title
            form.querySelector('input[name="director"]').value = dvd.director
            form.querySelector('input[name="genre"]').value = dvd.genre
            form.querySelector('input[name="price"]').value =  dvd.price
        }
        function clearForm(){
            var form = document.getElementById('createUpdateForm')

            form.querySelector('input[name="id"]').value = ''
            form.querySelector('input[name="id"]').disabled = false
            form.querySelector('input[name="title"]').value = ''
            form.querySelector('input[name="director"]').value = ''
            form.querySelector('input[name="genre"]').value = ''
            form.querySelector('input[name="price"]').value =  ''
        }
        function doCreate(){
            //console.log("in")
            dvd = getDvdFromForm()
            $.ajax({
                url:'/dvds',
                data: JSON.stringify(dvd),
                method: 'POST',
                dataType: 'JSON',
                contentType: "application/json; charset-utf-8",
                success: function(result){
                    console.log(result)
                    addDvdToTable(dvd)
                    showDisplay()
                    clearForm()
                },
                error: function(xhr, status, error){
                    console.log("error" + error + " code:" +status)
                }
            })
        }
        function doUpdate(){
            dvd = getDvdFromForm()
            updateServer(dvd)
        }
        function updateServer(dvd){
            $.ajax({
                url:'/dvds/'+dvd.id,
                data: JSON.stringify(dvd),
                method: 'PUT',
                dataType: 'JSON',
                contentType: "application/json; charset-utf-8",
                success: function(result){
                    updateTableRow(dvd)
                    showDisplay()
                    clearForm()
                },
                error: function(xhr, status, error){
                    console.log("error" + error + " code:" +status)
                }
            })
        }
        function updateTableRow(dvd){
            rowElement = document.getElementById(dvd.id)
            rowElement.cells[1].firstChild.textContent = dvd.title
            rowElement.cells[2].firstChild.textContent = dvd.director
            rowElement.cells[3].firstChild.textContent = dvd.genre
            rowElement.cells[4].firstChild.textContent = dvd.price
        }
        function doDelete(thisElem){
            var tableElement = document.getElementById('dvdTable');
            var rowElement = thisElem.parentNode.parentNode;
            var index = rowElement.rowIndex;
            id = rowElement.getAttribute("id");
            $.ajax({
                url:'/dvds/'+id,
                method: 'DELETE',
                dataType: 'JSON',
                contentType: "application/json; charset-utf-8",
                success: function(result){
                    tableElement.deleteRow(index);
                },
                error: function(xhr, status, error){
                    console.log("error" + error + " code:" +status)
                }
            })
        }
        function getdvdFromForm(){
            var form = document.getElementById('createUpdateForm')
            var dvd = {}
            dvd.id = form.querySelector('input[name="id"]').value
            dvd.title = form.querySelector('input[name="title"]').value
            dvd.director = form.querySelector('input[name="director"]').value
            dvd.genre = form.querySelector('input[name="genre"]').value
            dvd.price = form.querySelector('input[name="price"]').value
            //console.log("dvd")
            return dvd
        }
        function showDisplay(){
            document.getElementById('display').style.display = "block"
            document.getElementById('create-update').style.display = "none"
        }
        host = window.location.origin
        function populateTable(){
            //ajax getAll
            $.ajax({
                url:host+'/dvds',
                method: 'GET',
                dataType: 'JSON',
                success: function(results){
                    for (dvd of results){
                        addDvdToTable(dvd)
                    }
                },
                error: function(xhr, status, error){
                    console.log("error" + error + " code:" +status)
                }
            })
        }
        function addDvdToTable(dvd){
            //console.log("working")
            tableElem = document.getElementById("dvdTable")
            rowElem = tableElem.insertRow(-1)
            rowElem.setAttribute("id", dvd.id)
            cell1 = rowElem.insertCell(0)
            cell1.innerHTML = dvd.id
            rowElem.setAttribute("title", dvd.title)
            cell2 = rowElem.insertCell(1)
            cell2.innerHTML = dvd.title
            rowElem.setAttribute("director", dvd.director)
            cell3 = rowElem.insertCell(2)
            cell3.innerHTML = dvd.director
            rowElem.setAttribute("genre", dvd.genre)
            cell3 = rowElem.insertCell(3)
            cell3.innerHTML = dvd.genre
            rowElem.setAttribute("price", dvd.price)
            cell4 = rowElem.insertCell(4)
            cell4.innerHTML = dvd.price
            cell5 = rowElem.insertCell(5)
            cell5.innerHTML = '<button onclick ="showUpdate(this)" type="button" class="btn btn-success">Update</button>'
            cell6 = rowElem.insertCell(6)
            cell6.innerHTML = '<button onclick ="doDelete(this)" type="button" class="btn btn-success">Delete</button>'
            }   
        populateTable()
    </script>
</body>
</html>